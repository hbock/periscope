<h2><a name="title"/><b>Help Topic</b>: Argus Filter Expressions<sup><a href="#foot">1</a></sup></h2>
<p/>
<p> All reports generated by Periscope must be associated with an Argus filter.
This filter specifies which <a href='http://qosient.com/argus'><b>argus(5)</b></a>
records will be selected for processing by Periscope.  Filters are specified by expressions
in a language very similar to that of <a href='http://tcpdump.org'><b>tcpdump(1)</b></a>.
This document describes the syntax of this language and provides several useful examples.
</p>

<h3>Using Filter Expressions</h3>
<p>If no <i>expression</i> is given, all records
are processed, otherwise, only those records for which <i>expression</i> is &lsquo;true&rsquo;
will be printed.</p>

<p> The syntax for Argus filters is very similar to the expression syntax for <b>tcpdump(1)</b>,
but the semantics for tcpdump packet filter expression
are different when applied to transaction record filtering, so there are
some major differences. </p>

<p>The <i>expression</i> consists of one or more <i>primitives.</i>
Primitives usually consist of an <i>id</i> (name or number) preceded by one or
more qualifiers.  There are three different kinds of qualifiers: 
<dl>

<dt><i>type</i></dt>
<dd>Type qualifiers
specify what kind of thing the id name or number refers to. Possible types are
<b>srcid,</b> <b>encaps,</b> <b>host,</b> <b>net,</b> <b>port,</b> <b>tos,</b> <b>ttl,</b> <b>ptks,</b> <b>bytes,</b> <b>appbytes,</b> <b>data,</b>
<b>rate,</b> <b>load,</b> <b>loss,</b> <b>ploss,</b> <b>mid,</b> <b>vid,</b> <b>vpri,</b> and <b>mid.</b> 
<p> 
Some examples of <i>type</i> qualifiers are:
  <ul>
    <li>&lsquo;srcid isis&lsquo;</li>
    <li>&lsquo;encaps gre&rsquo;</li>
    <li>&lsquo;host sphynx&rsquo;</li>
    <li>&lsquo;net 192.168.0.0/16&rsquo;</li>
    <li>&lsquo;port domain&rsquo;</li>
    <li>&lsquo;ttl 1&rsquo;</li>
    <li>&rsquo;ptks gt 2&rsquo;</li>
    <li>&rsquo;ploss lt 5&rsquo;</li>
  </ul>
If no type qualifier is specified, <b>host</b> is assumed. </dd>
</p>

<dt><i>dir</i></dt>
<dd>Dir qualifiers specify
a particular transfer direction to and/or from <i>an</i> id. Possible directions
are <b>src</b>, <b>dst</b>, <b>src or dst</b> and <b>src and dst</b>. E.g., &lsquo;src sphynx&rsquo;, &lsquo;dst net 192.168.0.0/24&rsquo;,
&lsquo;src or dst port ftp&rsquo;, &lsquo;src and dst tos 0x0a&rsquo;, &lsquo;src or dst vid 0x12&lsquo;, &lsquo;dst vpri
0x02&lsquo; . If no dir qualifier is specified, <b>src or dst</b> is assumed. </dd>

<dt><i>proto</i></dt>
<dd>Proto qualifiers
restrict the match to a particular <i>protocol</i>.  Possible values are those
specified in the <b>/etc/protocols</b> system file and a small number of extensions,
(that should be defined but aren&rsquo;t).  Specific extended values are <b>&rsquo;ipv4&rsquo;</b>,
(to specify just ip version 4), in contrast to the defined proto <b>&rsquo;ipv6&rsquo;</b>. The
defined proto <b>&rsquo;ip&rsquo;</b> reduces to the filter &rsquo;ipv4 or ipv6&rsquo;. 
<p> When preceeded by
<i>ether</i>, the protocol names and numbers that are valid are specified in <b>include/ethernames.h</b>
in the Argus clients source distribution.
</dd>
</dl>
<p>
In addition to the above, there are some special &lsquo;primitive&rsquo; keywords that
don&rsquo;t follow the pattern: <b>gateway</b>, <b>multicast</b>, and <b>broadcast</b>. All of these
are described below. <p>
More complex filter expressions are built up by using
the words <b>and</b>, <b>or</b> and <b>not</b> to combine primitives.  For example, <i>"host foo and not port
ftp and not port ftp-data"</i>. To save typing, identical qualifier lists can
be omitted.  For example, <i>"tcp dst port ftp or ftp-data or domain"</i> is exactly the same
as <i>"tcp dst port ftp or tcp dst port ftp-data or tcp dst port domain"</i>. <p>
Allowable primitives are: 
<dl>

<dt><b>srcid <i>argusid</i></b></dt>
<dd>True if the argus identifier field in the
Argus record is <i>srcid</i>, which may be an IP address, a name or a decimal/hexidecimal
number. </dd>

<dt><b>encaps <i>type</i></b></dt>
<dd>True if the encapsulation used by the flow in the Argus
record includes the <i>type</i>.  The list of valid encapsulation types is: <br>
<pre>
 mpls, eth, 802q, llc, pppoe, isl, gre, ah, ipnip, ipnip6, chdlc
dst host hostTrue if the IP destination field in the Argus record is host,
which may be either an address or a name.
src host hostTrue if the IP source field in the Argus record is host.
host hostTrue if either the IP source or destination in the Argus record
is host.
Any of the above host expressions can be prepended with the keywords
ip, arp, or rarp as in:

ip host host
</pre> which is equivalent to:  <br>
<pre>ether proto ip and host host
</pre> If <i>host</i> is a name with multiple IP addresses, each address will be checked
for a match. </dd>

<dt><b>ether dst <i>ehost</i></b></dt>
<dd>True if the ethernet destination address is
<i>ehost</i>.  <i>Ehost</i> may be either a name from /etc/ethers or a number (see <a href='ethers.3N'><i>ethers</i>(3N)</a>

for numeric format). </dd>

<dt><b>ether src <i>ehost</i></b></dt>
<dd>True if the ethernet source address
is <i>ehost</i>. </dd>

<dt><b>ether host <i>ehost</i></b></dt>
<dd>True if either the ethernet source or destination
address is <i>ehost</i>. </dd>

<dt><b>gateway</b> <i>host</i></dt>
<dd>True if the transaction used <i>host</i> as a gateway.
 I.e., the ethernet source or destination address was <i>host</i> but neither the
IP source nor the IP destination was <i>host</i>.  <i>Host</i> must be a name and must
be found in both /etc/hosts and /etc/ethers.  (An equivalent expression
is  <br>
<pre>ether host ehost and not host host
</pre> which can be used with either names or numbers for <i>host / ehost</i>.) </dd>

<dt><b>dst net
<i>cidr</i></b></dt>
<dd>True if the IP destination address in the Argus record matches the
<i>cidr</i> address. </dd>

<dt><b>src net <i>cidr</i></b></dt>
<dd>True if the IP source address in the Argus record
matches the <i>cidr</i> address. </dd>

<dt><b>net <i>cidr</i></b></dt>
<dd>True if either the IP source or destination
address in the Argus record matches  <i>cidr</i> address. </dd>

<dt><b>dst port <i>port</i></b></dt>
<dd>True if
the network transaction is ip/tcp or ip/udp and has a destination port
value of <i>port</i>. The <i>port</i> can be a number or a name used in /etc/services
(see <a href='tcp.4P'><i>tcp</i>(4P)</a>
 and <a href='udp.4P'><i>udp</i>(4P)</a>
). If a name is used, both the port number and protocol
are checked.  If a number or ambiguous name is used, only the port number
is checked (e.g., <b>dst port 513</b> will print both tcp/login traffic and udp/who
traffic, and <b>port domain</b> will print both tcp/domain and udp/domain traffic).
</dd>

<dt><b>src port <i>port</i></b></dt>
<dd>True if the network transaction has a source port value of
<i>port</i>. </dd>

<dt><b>port <i>port</i></b></dt>
<dd>True if either the source or destination port in the Argus
record is <i>port</i>. Any of the above port expressions can be prepended with
the keywords, <b>tcp</b> or <b>udp</b>, as in:  <br>
<pre>tcp src port port
</pre> which matches only tcp connections. </dd>

<dt><b>ip proto <i>protocol</i></b></dt>
<dd>True if the Argus
record is an ip transaction (see <a href='ip.4P'><i>ip</i>(4P)</a>
) of protocol type <i>protocol</i>. <i>Protocol</i>
can be a number or any of the string values found in <i>/etc/protocols</i>. </dd>

<dt><b>multicast</b></dt>
<dd>True
if the network transaction involved an ip multicast address. By specifing
ether multicast, you can select argus records that involve an ethernet
multicast address. </dd>

<dt><b>broadcast</b></dt>
<dd>True if the network transaction involved an
ip broadcast address. By specifing ether broadcast, you can select argus
records that involve an ethernet broadcast address. </dd>

<dt><b>ether proto <i>protocol</i></b></dt>
<dd>True
if the Argus record is of ether type <i>protocol</i>. <i>Protocol</i> can be a number
or a name like <i>ip</i>, <i>arp</i>, or <i>rarp</i>. </dd>

<dt><b>[src | dst] ttl [gt | gte | lt | lte | eq] <i>number</i></b></dt>
<dd>True
if the TTL in the Argus record equals <i>number</i>. </dd>

<dt><b>[src | dst] tos [gt | gte | lt
| lte | eq] <i>number</i></b></dt>
<dd>True if the TOS in the Argus record (default) equals <i>number</i>.
</dd>

<dt><b>[src | dst] vid [gt | gte | lt | lte | eq] <i>number</i></b></dt>
<dd>True if th VLAN id in the Argus
record (default) equals <i>number</i>. </dd>

<dt><b>[src | dst] vpri [gt | gte | lt | lte | eq] <i>number</i></b></dt>
<dd>True
if the VLAN priority in the Argus record (default) equals <i>number</i>. </dd>

<dt><b>[src |
dst] mid [gt | gte | lt | lte | eq] <i>number</i></b></dt>
<dd>True if the MPLS Label in the Argus
record (default) equals <i>number</i>. </dd>

<dt><b>[src | dst] pkts [gt | gte | lt | lte | eq] <i>number</i></b></dt>
<dd>True
if the packet count in the Argus record (default) equals <i>number</i>. </dd>

<dt><b>[src | dst]
bytes [gt | gte | lt | lte | eq] <i>number</i></b></dt>
<dd>True if the byte count in the Argus
record (default) equals <i>number</i>. </dd>

<dt><b>[src | dst] appbytes [gt | gte | lt | lte | eq]
<i>number</i></b></dt>
<dd>True if the application byte count in the Argus record (default)
equals <i>number</i>. </dd>

<dt><b>[src | dst] rate [gt | gte | lt | lte | eq] <i>number</i></b></dt>
<dd>True if the
rate in the Argus record (default) equals <i>number</i>. </dd>

<dt><b>[src | dst] load [gt | gte
| lt | lte | eq] <i>number</i></b></dt>
<dd>True if the load in the Argus record (default) equals
<i>number</i>. 
<p> </dd>
</dl>
<p>
Ra filter expressions support primitives that are specific to flow
states and can be used to select flow records that were in these states
at the time they were generated. <i>normal</i>, <i>wait</i>, <i>timeout</i>, <i>est</i> or <i>con</i> 
<p> Primitives
that select flows that experienced fragmentation. <i>frag</i> and <i>fragonly</i> 
<p> Support
for selecting flows that used multiple pairs of MAC addresses during their
lifetime. <i>multipath</i> 

<p> <p>
Primitives specific to TCP flows are supported. <i>syn</i>,
<i>synack</i>, <i>ecn</i>, <i>fin</i>, <i>finack</i>, <i>reset</i>, <i>retrans</i>, <i>outoforder</i> and <i>winshut</i> 
<p> Primitives
specific to ICMP flows are supported. <i>echo</i>, <i>unreach</i>, <i>redirect</i> and <i>timexed</i>

<p> <p>
For some primitives, a direction qualifier is appropriate. These are <i>frag</i>,
<i>reset</i>, <i>retrans</i>, <i>outoforder</i> and <i>winshut</i> 
<p> <p>
Primitives may be combined using:

<dl>

<dt>A parenthesized group of primitives and operators </dt>
<dd>(parentheses are special
to the Shell and must be escaped). </dd>

<dt>Negation (&lsquo;<b>!</b>&rsquo; or &lsquo;<b>not</b>&rsquo;). </dt>
<dd></dd>

<dt>Concatenation (&lsquo;<b>and</b>&rsquo;).
</dt>
<dd></dd>

<dt>Alternation (&lsquo;<b>or</b>&rsquo;). </dt>
<dd></dd>
</dl>
<p>
Negation has highest precedence. Alternation and concatenation
have equal precedence and associate left to right.  Note that explicit <b>and</b>
tokens, not juxtaposition, are now required for concatenation. <p>
If an identifier
is given without a keyword, the most recent keyword is assumed. For example,
 <br>
<pre>not host sphynx and anubis
</pre> is short for  <br>
<pre>not host sphynx and host anubis
</pre> which should not be confused with  <br>
<pre>not ( host sphynx or anubis )
</pre> <p>
Expression arguments can be passed to <a href='ra.1'><b>ra(1)</b></a>
 as either a single argument
or as multiple arguments, whichever is more convenient. Generally, if the
expression contains Shell metacharacters, it is easier to pass it as a
single, quoted argument. Multiple arguments are concatenated with spaces
before being parsed. 
<p> 
<h2><a name='examples'>Filter Examples</a></h2>
To process all TCP transactions from and to host &rsquo;narly.wave.com&rsquo;:
<blockquote>
<pre>tcp and host narly.wave.com
</pre></blockquote>
<p>
Process all ICMP events involving the host nimrod:
<blockquote>
<pre>icmp and host nimrod
</pre></blockquote>
<br>
<small><a name="foot" href="#title">1.</a> Adapted from the ra(1) man page in the Argus clients
distribution.</small>
